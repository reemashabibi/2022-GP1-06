<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>التسجيل</title>
  <link href="register.css" rel="stylesheet">
  <link href="style.css" rel="stylesheet">
  <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"></script>



</head>

<body>

  <div class="center">
    <a class="navbar-brand navbar-logo sideLogo" href="#"><img src="navbarlogo.png" alt="logo" height="66"></a>
    <h1>سجل مدرستك في حلقة</h1>
    <div class="loader topTitle" style="top: 25vmax;"></div>
    <form id="signForm">
      <div class="inputbox" id="alertContainer">
        <span class="req" style="color: red;">جميع الحقول مطلوبة*</span>
      </div>

      <div class="inputbox">
        <input type="text" required="required" id="snameInp">
        <span>اسم المدرسة </span>
      </div>
    
      <div class="inputbox">
        <input type="text" required="required" id="fnameInp">
        <span>الاسم الأول لمدير المدرسة</span>
      </div>
      <div class="inputbox">
        <input type="text" required="required" id="lnameInp">
        <span>الاسم الأخير لمدير المدرسة</span>
      </div>
      <div class="inputbox">
        <input type="email" required="required" id="emailInp">
        <span>البريد الإلكتروني</span>
      </div>
      <div class="inputbox">
        <input type="password" required="required" id="passInp">
        <span>كلمة المرور</span>
      </div>
  
      <div class="inputbox">
        <span class="req" style="color: red;">كلمة المرور يجب أن تكون أكثر من ٦ أحرف و/أو أرقام*</span>
      </div>
      

      <div class="inputbox">
        <button type="text" id="subButton" class="btn" type="button">تسجيل</button>
      </div>
    </form>
    <br>
    <br>
    <div>
      <a href="index.html" class="alink"> مدرستك مسجلة مسبقاً ؟</a>
    </div>

  </div>

  <div class="screen__background">
    <span class="screen__background__shape screen__background__shape5"></span>
    <span class="screen__background__shape screen__background__shape4"></span>
    <span class="screen__background__shape screen__background__shape3"></span>		
    <span class="screen__background__shape screen__background__shape2"></span>
    <span class="screen__background__shape screen__background__shape1"></span>
  </div>



  <script type="module">

    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.12.1/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/9.12.1/firebase-analytics.js";
    import { collection, getDocs, addDoc, Timestamp, deleteDoc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/9.12.1/firebase-firestore.js";
    import { query, orderBy, limit, where, onSnapshot } from "https://www.gstatic.com/firebasejs/9.12.1/firebase-firestore.js";
    import { doc, setDoc } from "https://www.gstatic.com/firebasejs/9.12.1/firebase-firestore.js";
    import { getFirestore } from "https://www.gstatic.com/firebasejs/9.12.1/firebase-firestore.js";
    import { get, ref } from "https://www.gstatic.com/firebasejs/9.12.1//firebase-database.js";
    import { getAuth, createUserWithEmailAndPassword , updateProfile} from "https://www.gstatic.com/firebasejs/9.12.1/firebase-auth.js";




    const firebaseConfig = {
      apiKey: "AIzaSyAk1XvudFS302cnbhPpnIka94st5nA23ZE",
      authDomain: "halaqa-89b43.firebaseapp.com",
      projectId: "halaqa-89b43",
      storageBucket: "halaqa-89b43.appspot.com",
      messagingSenderId: "969971486820",
      appId: "1:969971486820:web:40cc0abf19a909cc470f71",
      measurementId: "G-PCYTHJF1SD"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);

    export { app, db, collection, getDocs, Timestamp, addDoc, setDoc };
    export { query, orderBy, limit, where, onSnapshot };
    const analytics = getAnalytics(app);


    const db = getFirestore(app);
    const colRefSchool = collection(db, "School");
    const colRefP = collection(db, "Principal");




    // save user input 
    const schoolName = document.getElementById("snameInp");
    
    const FirstName = document.getElementById("fnameInp");
    const LastName = document.getElementById("lnameInp");
    var Email = document.getElementById("emailInp");
    const Password = document.getElementById("passInp");
    const submit = document.getElementById("subButton");
    const signForm = document.getElementById('signForm');



    $(".loader").hide();

    submit.addEventListener('click', async (e) => {
      Email = Email.value.toLowerCase();
      $(".loader").show();
      e.preventDefault()
      if (!validate()) {
        return false;
      }
      //check if school exitsts
      const q = query(collection(db, "School"), where("schoolName", "==", schoolName.value));
      const querySnapshot = await getDocs(q);
      var exist = false;
      querySnapshot.forEach((doc) => {
        if (!doc.empty)
          exist = true;


      });

      if (!exist) {


        const auth = getAuth();
        createUserWithEmailAndPassword(auth, Email, Password.value)
          .then(async (userCredential) => {
            // Signed in 
            const user = userCredential.user;
            
            const schoolref = doc(db, "School", user.uid);
        
            await setDoc(doc(db, "School", user.uid), {
              schoolName: schoolName.value,
              Email: Email,
              PrincipalFirstName:FirstName.value,
              PrincipalLastName: LastName.value,
            }).catch((error) => {
                console.log(error);
                $(".loader").hide();
                alert(error);
              });

              await updateProfile(auth.currentUser, {
              displayName:"Principal",
           });
               
    
           document.getElementById('alertContainer').innerHTML = '<div style="width: 100%; margin: 0 auto;"> <div class="alert success">  <input type="checkbox" id="alert2"/> <label class="close" title="close" for="alert2"> <i class="icon-remove"></i>  </label>  <p class="inner">تم تسجيل المدرسة بنجاح</p> </div>';
              setTimeout(() => {
              
                // 👇️ replace element from DOM
                document.getElementById('alertContainer').innerHTML = '<span style="color: rgb(157, 48, 48);" class="req">جميع الحقول مطلوبة*</span>';
          
              }, 5000);
            signForm.reset();
            window.location.href = "principalHomePage.html";
            

          })
          .catch((error) => {
            const errorCode = error.code;
            const errorMessage = error.message;
            console.log(errorMessage);
            if (errorMessage =="Firebase: Error (auth/email-already-in-use)."){
              $(".loader").hide();
  
           document.getElementById('alertContainer').innerHTML = '<div style="width: 100%; margin: 0 auto;"> <div class="alert error">  <input type="checkbox" id="alert1"/> <label class="close" title="close" for="alert1"> <i class="icon-remove"></i>  </label>  <p class="inner">البريد الالكتروني مستخدم من قبل</p> </div>';
              setTimeout(() => {
              
                // 👇️ replace element from DOM
                document.getElementById('alertContainer').innerHTML = '<span style="color: rgb(157, 48, 48);" class="req">جميع الحقول مطلوبة*</span>';
          
              }, 5000);
          }
           else{
            $(".loader").hide();

           document.getElementById('alertContainer').innerHTML = '<div style="width: 100%; margin: 0 auto;"> <div class="alert error">  <input type="checkbox" id="alert1"/> <label class="close" title="close" for="alert1"> <i class="icon-remove"></i>  </label>  <p class="inner">حدث خطأ حاول مره أخرى</p> </div>';
              setTimeout(() => {
              
                // 👇️ replace element from DOM
                document.getElementById('alertContainer').innerHTML = '<span style="color: rgb(157, 48, 48);" class="req">جميع الحقول مطلوبة*</span>';
          
              }, 5000);
            signForm.reset();
          }
          });


        /* else {
           alert(" يوجد خطأ يرجى المحاولة في وقت لاحق ");
         }*/

      }
      else {
        $(".loader").hide();
        document.getElementById('alertContainer').innerHTML = '<div style="width: 100%; margin: 0 auto;"> <div class="alert error">  <input type="checkbox" id="alert1"/> <label class="close" title="close" for="alert1"> <i class="icon-remove"></i>  </label>  <p class="inner">المدرسة مسجلة مسبقاً</p> </div>';
              setTimeout(() => {
              
                // 👇️ replace element from DOM
                document.getElementById('alertContainer').innerHTML = '<span style="color: rgb(157, 48, 48);" class="req">جميع الحقول مطلوبة*</span>';
          
              }, 5000);
        signForm.reset();
      }
    });



  </script>


  <script type="text/javascript">

    const Firstname = document.getElementById("fnameInp");
    const Lastname = document.getElementById("lnameInp");
    const Email1 = document.getElementById("emailInp");
    const password = document.getElementById("passInp");
    const schoolname = document.getElementById("snameInp");
    


    function validate() {

      if (Firstname.value == "" || Lastname.value == "" || schoolname.value == "" ||  password.value == "") {
        $(".loader").hide();

        document.getElementById('alertContainer').innerHTML = '<div style="width: 100%; margin: 0 auto;"> <div class="alert error">  <input type="checkbox" id="alert1"/> <label class="close" title="close" for="alert1"> <i class="icon-remove"></i>  </label>  <p class="inner">جميع الحقول مطلوبة يرجى التحقق من تعبئتها</p> </div>';
        setTimeout(() => {
              
              // 👇️ replace element from DOM
              document.getElementById('alertContainer').innerHTML = '<span style="color: rgb(157, 48, 48);" class="req">جميع الحقول مطلوبة*</span>';
        
            }, 5000);
        return false;
      }




     

      if (password.value.length < 6) {
        $(".loader").hide();

        document.getElementById('alertContainer').innerHTML = '<div style="width: 100%; margin: 0 auto;"> <div class="alert error">  <input type="checkbox" id="alert1"/> <label class="close" title="close" for="alert1"> <i class="icon-remove"></i>  </label>  <p class="inner">لا يمكن لكلمة السر أن تكون أقل من ٦ أحرف أو أرقام </p> </div>';
              setTimeout(() => {
              
                // 👇️ replace element from DOM
                document.getElementById('alertContainer').innerHTML = '<span style="color: rgb(157, 48, 48);" class="req">جميع الحقول مطلوبة*</span>';
          
              }, 5000);
        return false;
      }

      else {
        return true;
      }
    }

  </script>

<script>
  function myFunction() {
   var x = document.getElementById("passInp");
   if (x.type === "password") {
     x.type = "text";
   } else {
     x.type = "password";
   }
 }
 </script>






</body>

</html>