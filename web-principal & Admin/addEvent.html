<!DOCTYPE html>
<html lang="en">
    <script type="module">
     /* import{checkUser} from "./admin.js";
      import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.12.1/firebase-auth.js";
  const auth = getAuth();
  

  checkUser();
       
       
           const logout= document.getElementById("signout");
       
           logout.addEventListener('click',  async (e) => {
     e.preventDefault()
     if(confirm("هل تُأكد تسجيل الخروج من الحساب؟")){
     signOut(auth).then(() => {
       alert("تم تسجيل الخروج بنجاح");
       window.location.href="index.html";
       }).catch((error) => {
       console.log(error.message);
       }); 
   }
    }); */
       
       
       </script>
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>إضافة حدث</title>
    

     <link rel="stylesheet" href="navbar.css"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/css/bootstrap.min.css"/>
    <link rel="stylesheet" href=" https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.10.2/css/all.css"/>
    <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
<script src="navbar.js"></script>

    <script src="https://code.jquery.com/jquery-1.10.2.min.js"></script>
    <link href="eventUA.css" rel="stylesheet">
   
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.4.1/dist/js/bootstrap.bundle.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/material-design-iconic-font/2.2.0/css/material-design-iconic-font.min.css" integrity="sha256-3sPp8BkKUE7QyPSl6VfBByBroQbKxKG7tsusY2mhbVY=" crossorigin="anonymous" />
    <style>
      main {
     margin: 0;
     margin-top: 30px;
     margin-bottom: 30px;
     padding: 0;
     box-sizing: border-box;
     display:grid;
     justify-content:center;
     align-items: center;
   }
       </style>
</head>
<body>
 <!--start of nav -->
 <nav class="navbar navbar-expand-custom navbar-mainbg">
  <a class="navbar-brand navbar-logo" href="#"><img src="navbarlogo.png" alt="logo" height="66"></a>
  <svg viewBox="0 0 512 512" width="30" title="sign-out-alt" id="signout">
<path d="M497 273L329 441c-15 15-41 4.5-41-17v-96H152c-13.3 0-24-10.7-24-24v-96c0-13.3 10.7-24 24-24h136V88c0-21.4 25.9-32 41-17l168 168c9.3 9.4 9.3 24.6 0 34zM192 436v-40c0-6.6-5.4-12-12-12H96c-17.7 0-32-14.3-32-32V160c0-17.7 14.3-32 32-32h84c6.6 0 12-5.4 12-12V76c0-6.6-5.4-12-12-12H96c-53 0-96 43-96 96v192c0 53 43 96 96 96h84c6.6 0 12-5.4 12-12z" />
</svg>

<svg viewBox="0 0 496 512" width="30" title="user-circle" id="updateAccountLogo" onclick="window.location.href='editAdmin.html'">
<path d="M248 8C111 8 0 119 0 256s111 248 248 248 248-111 248-248S385 8 248 8zm0 96c48.6 0 88 39.4 88 88s-39.4 88-88 88-88-39.4-88-88 39.4-88 88-88zm0 344c-58.7 0-111.3-26.6-146.5-68.2 18.8-35.4 55.6-59.8 98.5-59.8 2.4 0 4.8.4 7.1 1.1 13 4.2 26.6 6.9 40.9 6.9 14.3 0 28-2.7 40.9-6.9 2.3-.7 4.7-1.1 7.1-1.1 42.9 0 79.7 24.4 98.5 59.8C359.3 421.4 306.7 448 248 448z" />
</svg>
  <button class="navbar-toggler" type="button" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
  <i class="fas fa-bars text-black"></i>
  </button>
  <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto">
          <div class="hori-selector"><div class="left"></div><div class="right"></div></div>

       
          <li class="nav-item ">
              <a class="nav-link" href="pickup.html"> إصطحاب الطلاب</a>
          </li>
          <li class="nav-item">
              <a class="nav-link" href="javascript:void(0);"></i>الإعلانات</a>
          </li>
          <li class="nav-item">
              <a class="nav-link" href="events.html">الأحداث</a>
          </li>
          <li class="nav-item">
              <a class="nav-link" href="documents.html">المستندات</a>
          </li>
          <li class="nav-item active">
              <a class="nav-link" href="adminHomePage.html">الصفحة الرئيسية</a>
          </li>
      </ul>
  </div>
</nav>
<!--end of nav -->

<main>
    <div class="center"   >
      <br>
      <br>
        <h1 >  إضافة حدث إلى مدرستك </h1>
        
    <form id="addEvent" >
       
        
          <div class="inputbox">
            <input type="text" required="required" id="eventTitle">
            <span> العنوان</span>
          </div>
          
          <div class="inputbox">
            <textarea rows="5" cols="40" id="content"></textarea>
            <span> التفاصيل</span>
          </div>
          <br>
          <br>
          <br>
          <br>

          <div class="inputbox">
            
            <input type="file"  id="image" accept="image/*,.pdf,.jpg,.png">
            <span>إضافة صورة</span>
          </div>
          <div class="inputbox">
            <button  id="eventButton" class="button-36 topTitle" type="submit">إضافة</button>
          </div>

    </form>
    </div>
  </main>
</body>
</html>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.12.1/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/9.12.1/firebase-analytics.js";
    import { collection, collectionGroup, getDocs, addDoc,serverTimestamp, Timestamp, deleteDoc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/9.12.1/firebase-firestore.js";
    import { query, orderBy, limit, where, onSnapshot } from "https://www.gstatic.com/firebasejs/9.12.1/firebase-firestore.js";
    import { doc, setDoc } from "https://www.gstatic.com/firebasejs/9.12.1/firebase-firestore.js";
    import { getFirestore } from "https://www.gstatic.com/firebasejs/9.12.1/firebase-firestore.js";
    import { get } from "https://www.gstatic.com/firebasejs/9.12.1//firebase-database.js";
    import { getAuth, createUserWithEmailAndPassword , updateProfile} from "https://www.gstatic.com/firebasejs/9.12.1/firebase-auth.js";
    import { getStorage, uploadBytes, uploadBytesResumable ,getDownloadURL, ref} from "https://www.gstatic.com/firebasejs/9.12.1/firebase-storage.js";



    const firebaseConfig = {
      apiKey: "AIzaSyAk1XvudFS302cnbhPpnIka94st5nA23ZE",
      authDomain: "halaqa-89b43.firebaseapp.com",
      projectId: "halaqa-89b43",
      storageBucket: "halaqa-89b43.appspot.com",
      messagingSenderId: "969971486820",
      appId: "1:969971486820:web:40cc0abf19a909cc470f71",
      measurementId: "G-PCYTHJF1SD",
      storageBucket:"gs://halaqa-89b43.appspot.com"
    };
    const app = initializeApp(firebaseConfig);
    

    export { app, db, collection, getDocs, Timestamp, addDoc, setDoc };
    export { query, orderBy, limit, where, onSnapshot };
    const analytics = getAnalytics(app);
    const auth1= getAuth();
    

    const db = getFirestore(app);

    const title = document.getElementById("eventTitle");
    const content = document.getElementById("content");
    const image = document.getElementById('image');
    const saveButton = document.getElementById('eventButton');

    saveButton.addEventListener('click', async (e) => {
      e.preventDefault();
      
    

      const docSnap = await getDocs(query(collectionGroup(db, 'Admin'), where('Email', '==', auth1.currentUser.email)));
      var schoolId = "";

    docSnap.forEach((doc) => {

      schoolId = doc.ref.parent.parent.id;
    });
    const storage = getStorage(app);
    const reference = doc(db, "School", schoolId);
    const q = await collection(reference, "Event");
    const id1 = id();
     var imm="";  
    const file=document.querySelector("#image").files[0];
              
              if(file != null){
              const metadata = {
                contentType: file.type 
              };
              const storageRef = await ref(storage, 'images/' +file.name+id);
              const uploadTask = await uploadBytesResumable(storageRef, file, metadata);
              imm=file.name+id1;
            }
    
      
   


      await setDoc(doc(db, "School",schoolId,"Event",id1), {
              title: title.value,
              content: content.value,
              image:imm,
              time: serverTimestamp(),
            }).then(async (e) =>{
            
              alert("تم إضافة الحدث بنجاح");
              window.location.href="events.html"


            })
            .catch((error) => {
                console.log(error);
                alert(error);
              });

    
    
    })

    function id(){
    var chars = "0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz";
            var string_length = 10;
            var id = '';
            for (var i=0; i<string_length; i++) {
                var rnum = Math.floor(Math.random() * chars.length);
                id += chars.substring(rnum,rnum+1);
            }
        return id;
    }



</script>